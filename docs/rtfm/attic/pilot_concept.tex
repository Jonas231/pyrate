\documentclass[12pt,a4paper,twoside,openright,BCOR10mm,headsepline,titlepage,abstracton,chapterprefix,final]{scrreprt}

\usepackage{ae}
\usepackage[ngerman, english]{babel}
%\usepackage{SIunits}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{xcolor}
\usepackage{setspace}
\usepackage{dsfont}

% load hyperref as the last package to avoid redefinitions of e.g. footnotes after hyperref invokation

\RequirePackage{ifpdf}  % flag for pdf or dvi backend
\ifpdf
  \usepackage[pdftex]{graphicx}
  \usepackage[pdftitle={RTFM on Imaging Theory and Basics of Optical Raytracing},%
              pdfsubject={},%
              pdfauthor={M. Esslinger, J. Hartung, U. Lippmann},%
              pdfkeywords={},%
              bookmarks=true,%
%              colorlinks=true,%
              urlcolor=blue,%
              pdfpagelayout=TwoColumnRight,%
              pdfpagemode=UseNone,%
              pdfstartview=Fit,%
	      pdfpagelabels,
              pdftex]{hyperref}
\else
  \usepackage[dvips]{graphicx}
  \usepackage[colorlinks=false,dvips]{hyperref}
\fi
%\DeclareGraphicsRule{.jpg}{eps}{.jpg}{`convert #1 eps:-}

\usepackage{ae}
%\usepackage[ngerman, english]{babel}

%\usepackage{SIunits}
\newcommand\elementarycharge{\textrm{e}}
\newcommand\sccm{\textrm{sccm}}
\newcommand\mbar{\milli\textrm{bar}}


\usepackage{amsmath}
%\usepackage{amssymb}
\usepackage{setspace}

%\widowpenalty = 1000


\newcommand*{\doi}[1]{\href{https://doi.org/\detokenize{#1}}{doi: \detokenize{#1}}}

\newcommand\Vector[1]{{\mathbf{#1}}}

\newcommand\vacuum{0}

\newcommand\location{r}
\newcommand\Location{\Vector{r}}


\newcommand\wavenumber{k}
\newcommand\vacuumWavenumber{\wavenumber_{\vacuum}}
\newcommand\Wavevector{\Vector{\wavenumber}}

\newcommand\Nabla{\Vector{\nabla}}
\newcommand\Laplace{\Delta}
\newcommand\timederivative[1]{\dot{{#1}}}
\newcommand\Tensor[1]{\hat{#1}}
\newcommand\conjugate[1]{\overline{#1}}
\newcommand\transpose[1]{#1^{T}}
\newcommand\Norm[1]{\left| #1 \right|}
\newcommand{\ket}[1]{\left\vert{#1}\right\rangle}
\newcommand{\bra}[1]{\left\langle{#1}\right\vert}
\newcommand{\braket}[2]{\left\langle{#1}\vert{#2}\right\rangle}
\newcommand{\bracket}[1]{\left\langle{#1}\right\rangle}

\newcommand{\orderof}[1]{\mathcal{O}(#1)}

\newcommand{\scpm}[2]{(#1\,\cdot\,#2)}

\newcommand\Greenfunction{\Tensor{G}}

\newcommand\scalarEfield{E}
\newcommand\scalarBfield{B}
\newcommand\scalarHfield{H}
\newcommand\scalarDfield{D}
\newcommand\scalarTipfield{T}
\newcommand\scalarSamplefield{S}
\newcommand\scalarDipolarmoment{p}
\newcommand\Efield{\Vector{\scalarEfield}}
\newcommand\Bfield{\Vector{\scalarBfield}}
\newcommand\Hfield{\Vector{\scalarHfield}}
\newcommand\Dfield{\Vector{\scalarDfield}}
\newcommand\Dipolarmoment{\Vector{\scalarDipolarmoment}}

\newcommand\permeability{\Tensor{\mu}}
\newcommand\vacuumpermeability{\mu_{\vacuum}}
\newcommand\permittivity{\Tensor{\epsilon}}
\newcommand\generalPermittivity{\Tensor{\tilde\epsilon}}
\newcommand\vacuumpermittivity{\epsilon_{\vacuum}}
\newcommand\scalarpermittivity{\epsilon}
\newcommand\conductivity{\Tensor{\sigma}}
\newcommand\susceptibility{\Tensor{\chi}}
\newcommand\currentdensity{\Vector{j}}
\newcommand\Current{\Vector{I}}
\newcommand\chargedensity{\rho}
\newcommand\PoyntingVector{\Vector{S}}

\newcommand{\remark}[1]{{\color{red}$\blacksquare$}\footnote{{\color{red}#1}}}

\newif\ifdraft
\draftfalse % \drafttrue




\begin{document}


\paragraph{Ray Directions}

Both pilot and near-pilot ray direction must be normalized,
$|\Vector{d}_{pilot}|=|{\Vector{d}}|=1$.

\begin{eqnarray}
 |{\Vector{d}}|^2 = |\Vector{d}_{pilot}|^2 + 2 \Vector{d}_{pilot} \cdot \Delta\Vector{d} + |\Delta\Vector{d}|^2
\end{eqnarray}

In the limit of near pilot rays, terms quadratic in $\Delta\Vector{d}$ are negligible, $|\Delta\Vector{d}|^2 \rightarrow 0$. 
\begin{eqnarray}
0 &=& 2 \Vector{d}_{pilot} \cdot \Delta\Vector{d}
\end{eqnarray}
The change of direction must be perpendicular to the pilot direction, $\Vector{d}_{pilot} \perp \Delta\Vector{d}$. 
This leaves only two degrees of freedom for $\Delta\Vector{d}$.

\begin{eqnarray}
 \Delta\Vector{d} &=& U \Vector{e}_{U} + V \Vector{e}_{V}
\end{eqnarray}

We represent $\Delta\Vector{d}$ by two components $U$and $V$ 
and choose orthogonal unit vectors $\Vector{e}_{U} \perp \Vector{e}_{V} \perp \Vector{d}_{pilot} \perp \Vector{e}_{U}$,
forming a cartesian coordinate system.
We may choose (small) values for $U$ and $V$ independent from each other and independent from the pilot direction. 


\subsubsection{Unique choice of unit vectors}
We have basis systems for:
\begin{itemize}
 \item the cartesian global coordinates $( \Vector{e}_x, \Vector{e}_y, \Vector{e}_z )$
 \item the deviation from the pilot ray intersection $( \Vector{e}_X, \Vector{e}_Y )$
 \item the deviation of the ray direction $( \Vector{e}_U, \Vector{e}_V )$
 \item the deviation of the wavevector $( \Vector{e}_M, \Vector{e}_N )$
\end{itemize}
Up to now, the unit vectors to describe the deviations are not uniquely defined: 
we only demand that the pairs of vectors are linear independent and lay both in the plane of valid vectors, as discussed above.

In this section, we aim for an arbitrary choice of unit vectors, so that
\begin{itemize}
 \item all unit vectors are uniquely defined
 \item their computation and conversion is fast 
 \item the optimization of optical systems is robust.
\end{itemize}
For the robustness of optimization, 
we need to find unit vector definitions that do not change abruptly 
when applying small changes to the optical system.



For example, they should not contain an arcus tangent pole or limit in the normalization of close-to-zero vectors.
\remark{TODO: add a solution to the problem stated}

\subsubsection{Conversion of Wavevectors and Ray Directions}
TODO


\subsection{Propagation in Homogeneous Media}
In this section, we discuss propagation of rays to the tangential plane of the following surface.
In homogeneous media, rays are straight.

Assume we have a pilot ray with starting point $\Vector{r}_{pilot,0}$ and a near-pilot ray ${\Vector{r}_0}$.
First, we propagate the pilot ray to its intersection point $\Vector{r}_{pilot,1}$ with surface 1 and then the near pilot ray.

\begin{eqnarray}
 \Vector{r}_1 &=& \Vector{r}_0 + \Vector{d} t \\
 \Vector{r}_1 &=& (\Vector{r}_{0,pilot} + \Delta\Vector{r}_0) + (\Vector{d}_{pilot} + \Delta\Vector{d}) (t_{pilot} + \Delta t) \\ 
 %\Vector{r}_1 &=& \Vector{r}_{0,pilot} + \Delta\Vector{r}_0 + \Vector{d}_{pilot}t_{pilot} + \Vector{d}_{pilot}\Delta t + \Delta\Vector{d}t_{pilot} + \Delta\Vector{d}\Delta t \\
 %\Vector{r}_1 &=& \Vector{r}_{1,pilot} + \Delta\Vector{r}_0 + \Vector{d}_{pilot}\Delta t + \Delta\Vector{d}t_{pilot} + \Delta\Vector{d}\Delta t
\end{eqnarray} 

We expand
\begin{eqnarray}
 \Delta t \approx 
    \underbrace{
      \Delta t(\Delta\Vector{d} = 0, \Delta\Vector{r}_0 = 0)
    }_{=0}
    + \left. \frac{\partial t}{\partial\Vector{d}} \right|_{\Vector{d}_{pilot}}  \cdot \Delta\Vector{d} 
    + \left. \frac{\partial t}{\partial\Vector{r}} \right|_{\Vector{r}_{0,pilot}} \cdot \Delta\Vector{r}_0 
    + ...
    \label{eq:delta_t}
\end{eqnarray}
and find for near-pilot rays
\begin{eqnarray}
 \Vector{r}_1 &=& \Vector{r}_{1,pilot} + \Delta\Vector{r}_0 + \Vector{d}_{pilot}\Delta t + \Delta\Vector{d}t_{pilot} 
      + \frac{\partial t}{\partial\Vector{d}} \Delta\Vector{d}^2 
      + \frac{\partial t}{\partial\Vector{r}} \Delta\Vector{d} \Delta\Vector{r}_0 + ...
\end{eqnarray} 
We neglect all terms quadratic in the input arguments $(\Delta\Vector{d}, \Delta\Vector{r}_0)$
and leave the linear, lowest order terms
\begin{eqnarray}
 \Vector{r}_1 &=& \Vector{r}_{1,pilot} + \Delta\Vector{r}_0 + \Vector{d}_{pilot}\Delta t + \Delta\Vector{d}t_{pilot}
 \label{eq:nearpilotintersection}
\end{eqnarray} 
We represent each term of \ref{eq:nearpilotintersection} in the complete basis $(\Vector{e}_{X1}, \Vector{e}_{Y1}, \Vector{d}_{pilot}$).
\begin{eqnarray}
 \Delta\Vector{r}_0 &=& X_{1,0} \Vector{e}_{X1} + Y_{1,0} \Vector{e}_{Y1} + D_{1,0} \Vector{d}_{pilot} \\
 \Vector{d}_{pilot}\Delta t &=& X_{1,1} \Vector{e}_{X1} + Y_{1,1} \Vector{e}_{Y1} + D_{1,1} \Vector{d}_{pilot} \\
 \Delta\Vector{d}t_{pilot} &=& X_{1,2} \Vector{e}_{X1} + Y_{1,2} \Vector{e}_{Y1} + D_{1,2} \Vector{d}_{pilot} 
\end{eqnarray}
Decomposing the terms, one should consider that the basis might not be orthogonal.
One can see $X_{1,1} = 0$ and $Y_{1,1}=0$.
Comparing coefficients to the definition of the near-pilot intersection points (equation \ref{eq:deltaR_equals_XY}), 
we find the constraint
\begin{eqnarray}
 D_{1,0} + D_{1,1} + D_{1,2} &=& 0
\end{eqnarray}
as well as the final result
\begin{eqnarray}
 X_1 &=& X_{1,0} + X_{1,2} \\
 Y_1 &=& Y_{1,0} + Y_{1,2}
\end{eqnarray}



\subsection{Refraction}

We are interested in the change of the refracted wavevector $\Delta\Wavevector_2 = {\Wavevector}_2 - \Wavevector_{2, pilot}$ induced by $\Delta\Vector{r}$ and $\Delta\Wavevector$.
\begin{eqnarray}
 \Wavevector_{2, pilot} &=& \Wavevector_{\parallel, pilot} + \xi_{pilot} \Vector{n}_{pilot} 
 \\
 {\Wavevector}_2 &=& {\Wavevector}_{\parallel} + {\xi} {\Vector{n}} 
\end{eqnarray}
The refraction conserves the in-plane wavevector component. 
The out-of-plane or normal wavevector component $\xi_{pilot}, {\xi}$ after the refraction depends on the material permittivity and the in-plane component.
\begin{eqnarray}
 \Delta\Wavevector_2 =& ( {\Wavevector}_{\parallel} - \Wavevector_{\parallel, pilot} ) + ( {\xi} {\Vector{n}} - \xi_{pilot} \Vector{n}_{pilot} )&
\\[2ex]
 \Delta \wavenumber_{2,i} \approx&
   \left.
     \left( \delta_{ij}  - n_{i} n_{j} \right)
   \right|_{pilot}
   &\Delta\wavenumber_j
   \nonumber\\
   +&
   \left.
   \left(
     - \wavenumber_{j}  n_{i} 
     - (\wavenumber_{m} n_{m}) \delta_{ij}  
     + \xi \delta_{ij}
   \right) 
   \right|_{pilot}
   &\Delta n_{j}
   \nonumber \\
   +& n_{i, pilot} &\Delta\xi 
\end{eqnarray}
Next we try to express $\Delta\Vector{n}$ and $\Delta\xi$ as functions of $\Delta\Vector{r}$ and $\Delta\Wavevector$.


\subsubsection{The Derivative of the Normal Unit Vector}
We approximate $\Delta\Vector{n}$ in first order
\begin{eqnarray}
 \Delta n_i \approx \left. \frac{\partial n_i}{\partial r_j} \right|_{\Vector{r}_{pilot}} \Delta r_j
\end{eqnarray}
We introduce a scalar function $F$. The function shall represent the surface shape implicitly as $F(\Vector{r}) = 0$. 
One possible definition is $F = z - \textrm{sag}(x,y)$. The surface normal points in the direction of the gradient of $F$
\begin{eqnarray}
 n_i &=& \frac{\partial_i F}{\sqrt{(\partial_m F)(\partial_m F)}}
 \\
 \partial_j n_i &=& \frac{\partial_j \partial_\ell F}{\sqrt{(\partial_m F)(\partial_m F)}} \left(\delta_{\ell i} - n_\ell n_i\right)
 \label{eq:nderivative}
\end{eqnarray}
It links the derivative of the surface normal $\partial n$ to the second derivative of the surface sag 
or, in other words, to the surface curvature.


\subsubsection{The Derivative of the Normal Component Length}
The normal component of the wavevector $\xi$ in medium $\permittivity_2$ after the refraction 
is a function of incoming wavevector and the surface normal direction.
\begin{eqnarray}
 \xi &=& \xi(\Wavevector_{1}, \Vector{n}) \\
 \Delta \xi &=& 
     \left.  \frac{\partial \xi}{\partial k_{1i}}  \right|_{\Vector{n}=const} \cdot \Delta k_{1i}
   + \left. \frac{\partial \xi}{\partial n_j} \right|_{\Wavevector_{1}=const} \cdot \Delta n_j
\end{eqnarray}

TODO: adapt to new nomenclature

Hence by introducing $a$ and $a+1$ as the respective surface indices we may obtain a matrix formulation for the different delta parts
\begin{eqnarray}
 \Delta r_{a+1\,i} &=& \Delta r_{a\,i}\,,\\
 \Delta \wavenumber_{a+1\,i} &=& 
   \left( \delta_{ij}  - n_i n_j + n_i \frac{\partial \xi}{\partial \wavenumber_{a\,j}}\right) \Delta\wavenumber_{a\,j} \nonumber\\
   &+&
   \left[
      \left(
     - \wavenumber_{a\,j}  n_i 
     - \wavenumber_{a\,m} n_m \delta_{ij}  
     + \xi \delta_{ij}
     + n_i \frac{\partial \xi}{\partial n_j}
    \right) \partial_\ell n_j + \partial_\ell \xi\right]\Delta r_{a\,\ell}
\end{eqnarray}



\section{to do parts}

\subsection{Isotropic Media}
We assume a scalar, complex valued permittivity $\scalarpermittivity_2$.
\begin{eqnarray}
 \xi &=& \sqrt{\omega^2 \vacuumpermeability \scalarpermittivity_2 - \Wavevector_{\parallel} \cdot \Wavevector_{\parallel}} \nonumber\\
      &=& \sqrt{\omega^2 \vacuumpermeability \scalarpermittivity_2 - (\wavenumber_i - \wavenumber_j n_j n_i) \cdot (\wavenumber_i - \wavenumber_j n_j n_i)}
\end{eqnarray}
The partial derivatives which are necessary to compute the matrix elements are given by\remark{to be checked!}
\begin{eqnarray}
 \frac{\partial \xi}{\partial k_i} &=& -\frac{k_i - (k_\ell n_\ell) n_i}{\xi}\,,\\
 \frac{\partial \xi}{\partial n_i} &=& \frac{(k_m n_m) (k_i - (n_m k_m) n_i)}{\xi}\,.
\end{eqnarray}


\subsection{Conic interfaces}

We represent the change of the intersection location $\Delta\Vector{r}$ as function of 2 independent variables $\Delta x$ and $\Delta y$.
Although this difference is not changed by an optical interface.
\begin{eqnarray}
 \Delta\Vector{r} &=&
 \begin{pmatrix}
  \Delta x \\ \Delta y \\ z(x+\Delta x,y+\Delta y) - z(x,y)
 \end{pmatrix}
 \approx 
 \begin{pmatrix}
  \Delta x \\ \Delta y \\ \frac{\partial z}{\partial x} \Delta x + \frac{\partial z}{\partial y} \Delta y
 \end{pmatrix}
\end{eqnarray}
Normal vector (where $x$, $y$ and $z$ live in the vertex coordinate system)
\begin{eqnarray}
 \Vector{n} &=&- \frac{1}{\sqrt{ 1 - c \rho^2 (x^2 + y^2)}} 
  \begin{pmatrix}
   \rho x \\
   \rho y \\
   \rho ( 1 + c ) z(x,y) - 1
  \end{pmatrix}\,.
\end{eqnarray}
To use equation \eqref{eq:nderivative} we have to calculate the Hessian $\partial_i \partial_j F$ of the conic interface.
This can be done by using the implicit form of a conic section (the factor $\tfrac{1}{2}$ was added to remove the factors of two after
differentiation)
\begin{eqnarray}
 F(\Vector{r}) &=& \frac{1}{2}\rho (1+c) z^2 - z + \frac{1}{2} \rho(x^2 + y^2) = 0\,.
\end{eqnarray}
The partial derivatives are given by
\begin{eqnarray}
 \frac{\partial F}{\partial x} &=& \rho x\,,\\
 \frac{\partial F}{\partial y} &=& \rho y\,,\\
 \frac{\partial F}{\partial z} &=& \rho (1+c) z - 1\,,
\end{eqnarray}
and
\begin{eqnarray}
 \frac{\partial^2 F}{\partial x^2} &=& \rho\,, \quad\frac{\partial^2 F}{\partial x \partial y} = 0\,,\\
 \frac{\partial^2 F}{\partial y^2} &=& \rho\,, \quad\frac{\partial^2 F}{\partial y \partial z} = 0\,,\\
 \frac{\partial^2 F}{\partial z^2} &=& \rho (1+c)\,, \quad\frac{\partial^2 F}{\partial z \partial x} = 0\,,
\end{eqnarray}
Therefore the matrix of the normal vector derivatives is given by
\begin{eqnarray}
 (\partial_i n_j) &=& \frac{1}{\sqrt{ 1 - c \rho^2 (x^2 + y^2)}}
\begin{pmatrix}
  \rho & 0 & 0 \\
  0 & \rho & 0 \\
  0 & 0 & \rho(1+c)
\end{pmatrix}\cdot\nonumber\\
&&
\biggl[
\begin{pmatrix}
 1 & 0 & 0 \\
 0 & 1 & 0 \\
 0 & 0 & 1
\end{pmatrix}\nonumber\\
&&\quad
- \frac{1}{1 - c \rho^2 (x^2 + y^2)}\times\nonumber\\
&&\quad\quad
\begin{pmatrix}
 \rho^2 x^2 & \rho^2 x y & \rho x (\rho (1+c) z - 1) \\
 \rho^2 y x & \rho^2 y^2 & \rho y (\rho (1+c) z - 1) \\
 \rho x (\rho (1+c) z - 1) & \rho y (\rho (1+c) z - 1) & 1-\rho^2 (1+c) (x^2+y^2)%\rho^2 (1+c)^2 z^2 - 2 \rho (1+c) z + 1
\end{pmatrix}
\biggr]
\end{eqnarray}


% \begin{eqnarray}
%  \frac{\partial \Vector{n}}{\partial x} &=& \frac{\partial}{\partial x} \left(
% - \frac{1}{\sqrt{ 1 - c (x^2 + y^2)}} 
%   \begin{pmatrix}
%    \rho x \\
%    \rho y \\
%    \rho ( 1 + c ) z(x,y) - 1
%   \end{pmatrix}
%  \right)
% \end{eqnarray}




\subsection{Thin lenses}
We consider a thin lens in air with focal length $f$ isotropically in $\Vector{e}_U$ and $\Vector{e}_V$ direction
and identical unit vectors in front of and behind the surface, $\Vector{e}_{X,Y,U,V 0} = \Vector{e}_{X,Y,U,V 1}$.
Its XYUV matrix reads
\begin{eqnarray}
XYUV_{thin lens} &=&
 \begin{pmatrix}
  1 & 0 & 0 & 0 \\
  0 & 1 & 0 & 0 \\
  -\frac{1}{f} & 0 & 1 & 0 \\
  0 & -\frac{1}{f} & 0 & 1
 \end{pmatrix}
\end{eqnarray}

and for a cylindrical lens with a focal power tilted by $\theta$ with respect to the $Y$ axis

\begin{eqnarray}
XYUV_{cyl} &=&
 \begin{pmatrix}
  1 & 0 & 0 & 0 \\
  0 & 1 & 0 & 0 \\
  -\frac{1}{f} \sin^2\theta & -\frac{1}{f} \sin\theta \cos\theta & 1 & 0 \\
  -\frac{1}{f} \sin\theta \cos\theta & -\frac{1}{f} \cos^2\theta & 0 & 1
 \end{pmatrix}
\end{eqnarray}



\end{document}
